<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyTracker - クラウド学習管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        /* スクロールバー */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* ローディングアニメーション */
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; backdrop-blur: 4px;
        }
        
        /* スマホ用テーブル調整 */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }

        /* モバイルでの sticky 解除 */
        @media (max-width: 1024px) {
            .sticky-mobile-static { position: static !important; }
        }
    </style>
</head>
<body class="text-slate-800 antialiased min-h-screen flex flex-col">

    <div id="loadingOverlay" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-brand-500 border-t-transparent mb-4"></div>
        <p class="font-medium text-slate-600">データを同期中...</p>
    </div>

    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <i class="ph-fill ph-book-open-text text-brand-600 text-2xl sm:text-3xl"></i>
                    <span class="font-bold text-lg sm:text-xl tracking-tight">StudyTracker</span>
                </div>
                
                <div class="flex items-center gap-2 sm:gap-4">
                    <button onclick="openLoginModal()" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1.5 rounded font-medium transition-colors flex items-center gap-1">
                        <i class="ph ph-user-circle-plus"></i><span class="hidden sm:inline">IDログイン</span>
                    </button>
                    <div class="w-8 h-8 rounded-full bg-brand-500 flex items-center justify-center text-white font-bold text-sm">U</div>
                </div>
            </div>
        </div>
        <div class="flex border-t border-slate-100">
            <button onclick="switchView('dashboard')" id="tab-dashboard" class="flex-1 py-3 text-sm font-bold border-b-2 border-brand-500 text-brand-700 bg-brand-50/30 transition-all">ダッシュボード</button>
            <button onclick="switchView('mock-exams')" id="tab-mock-exams" class="flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition-all">模試の成績</button>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 w-full">
        
        <div id="dashboardView">
            <div class="mb-6">
                <h1 class="text-xl sm:text-2xl font-bold text-slate-900">ダッシュボード</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold uppercase">Cloud Connected</span>
                    <p id="idDisplay" class="text-[10px] font-mono text-slate-400 truncate max-w-[150px]"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8">
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 sticky top-32 sticky-mobile-static">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <i class="ph ph-plus-circle text-brand-500 text-xl"></i> 学習を記録
                        </h2>

                        <div class="flex p-1 mb-4 bg-slate-100 rounded-lg">
                            <button type="button" id="modeBtnManual" onclick="setInputMode('manual')" class="flex-1 py-2 text-sm font-bold rounded-md bg-white shadow-sm text-brand-700 transition-all">手動</button>
                            <button type="button" id="modeBtnTimer" onclick="setInputMode('timer')" class="flex-1 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-700 transition-all">タイマー</button>
                        </div>
                        
                        <form id="recordForm" class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">日付</label>
                                <input type="date" id="date" required class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">科目</label>
                                <select id="subject" required class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none bg-white text-sm">
                                    <option value="" disabled selected>選択してください</option>
                                    <option value="数的処理">数的処理</option>
                                    <option value="文章理解">文章理解</option>
                                    <option value="憲法">憲法</option>
                                    <option value="民法">民法</option>
                                    <option value="行政法">行政法</option>
                                    <option value="ミクロ経済学">ミクロ経済学</option>
                                    <option value="マクロ経済学">マクロ経済学</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                            
                            <div id="manualTimeInput">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">学習時間（分）</label>
                                <input type="number" id="duration" min="1" placeholder="例: 60" class="w-full px-4 py-2.5 border border-slate-300 rounded-xl text-sm">
                            </div>

                            <div id="timerTimeInput" class="hidden bg-slate-50 border border-slate-200 rounded-2xl p-4 text-center">
                                <div id="timerDisplay" class="text-3xl font-mono font-bold text-slate-800 mb-3 tracking-widest">00:00:00</div>
                                <div class="flex justify-center gap-2">
                                    <button type="button" id="timerStartBtn" onclick="toggleTimer()" class="flex-1 bg-brand-600 text-white py-2 rounded-lg font-bold text-sm">開始</button>
                                    <button type="button" id="timerPauseBtn" onclick="toggleTimer()" class="hidden flex-1 bg-amber-500 text-white py-2 rounded-lg font-bold text-sm">一時停止</button>
                                    <button type="button" onclick="resetTimer()" class="px-4 bg-slate-200 text-slate-600 py-2 rounded-lg"><i class="ph ph-arrow-counter-clockwise"></i></button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">メモ</label>
                                <textarea id="memo" rows="2" placeholder="内容など" class="w-full px-4 py-2.5 border border-slate-300 rounded-xl text-sm resize-none"></textarea>
                            </div>
                            
                            <button type="submit" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded-xl transition-all shadow-md shadow-brand-100 flex justify-center items-center gap-2">
                                <i class="ph ph-paper-plane-tilt"></i> 記録を保存
                            </button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="font-bold flex items-center gap-2"><i class="ph ph-calendar-star text-brand-500"></i> 試験日程</h2>
                            <button onclick="openExamModal()" class="p-2 text-slate-400 hover:text-brand-600"><i class="ph ph-plus-circle text-xl"></i></button>
                        </div>
                        <div id="examListDisplay" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Total Time</p>
                            <p class="text-xl font-bold text-brand-600" id="totalTimeDisplay">0h 0m</p>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">This Month</p>
                            <p class="text-xl font-bold text-green-600" id="totalDaysDisplay">0日</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
                        <div class="flex justify-between items-center mb-5">
                            <h2 class="font-bold">目標達成度</h2>
                            <button onclick="openGoalModal()" class="text-xs text-brand-600 font-bold">目標を変更</button>
                        </div>
                        <div class="space-y-5">
                            <div id="dailyProgress"></div>
                            <div id="weeklyProgress"></div>
                            <div id="monthlyProgress"></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
                        <h2 class="font-bold mb-4">科目別バランス</h2>
                        <div class="h-56 relative"><canvas id="subjectChart"></canvas></div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-200"><h2 class="font-bold text-sm text-slate-600 uppercase tracking-wider">Recent Activity</h2></div>
                        <div class="table-container">
                            <table class="w-full text-left">
                                <tbody id="recordList" class="divide-y divide-slate-100"></tbody>
                            </table>
                            <div id="emptyState" class="hidden p-10 text-center text-slate-400">
                                <i class="ph ph-ghost text-3xl mb-2"></i><p class="text-sm font-medium">記録がありません</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="mockExamView" class="hidden">
            <div class="mb-6">
                <h1 class="text-xl sm:text-2xl font-bold text-slate-900">模擬試験</h1>
                <p class="text-xs text-slate-400 mt-1 uppercase font-bold tracking-widest">Performance Tracking</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8">
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 sticky top-32 sticky-mobile-static">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="ph ph-chart-line-up text-brand-500"></i> 成績登録</h2>
                        <form id="mockExamForm" class="space-y-4">
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">実施日</label><input type="date" id="mockDate" required class="w-full px-4 py-2.5 border rounded-xl outline-none text-sm"></div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">模試名</label><input type="text" id="mockName" required placeholder="例: 第1回 公開模試" class="w-full px-4 py-2.5 border rounded-xl outline-none text-sm"></div>
                            <div class="flex gap-3">
                                <div class="w-1/2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">得点</label><input type="number" id="mockScore" required class="w-full px-4 py-2.5 border rounded-xl outline-none text-sm"></div>
                                <div class="w-1/2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">満点</label><input type="number" id="mockMaxScore" required class="w-full px-4 py-2.5 border rounded-xl outline-none text-sm"></div>
                            </div>
                            <button type="submit" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl transition-all shadow-lg flex justify-center items-center gap-2"><i class="ph ph-check-circle"></i> 成績を記録</button>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
                        <h2 class="font-bold mb-4">得点率の推移 (%)</h2>
                        <div class="h-64 sm:h-80 relative"><canvas id="mockScoreChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="table-container">
                            <table class="w-full text-left"><tbody id="mockList" class="divide-y divide-slate-100"></tbody></table>
                            <div id="mockEmptyState" class="hidden p-10 text-center text-slate-400"><p class="text-sm">データがありません</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="loginModal" class="hidden fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold mb-2">デバイス同期</h2>
            <p class="text-sm text-slate-500 mb-6">他デバイス（PC等）に表示されているIDを入力すると、データを同期できます。</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Your Current ID (タップでコピー)</label>
                    <div onclick="copyMyId()" id="myIdText" class="bg-slate-50 p-3 rounded-xl border border-dashed border-slate-300 font-mono text-xs break-all cursor-pointer hover:bg-slate-100 transition-colors">Loading...</div>
                </div>
                <hr class="border-slate-100">
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-1 font-bold">同期するIDを入力</label>
                    <input type="text" id="syncIdInput" placeholder="ここにIDを貼り付け" class="w-full px-4 py-3 border border-brand-200 rounded-xl outline-none focus:ring-2 focus:ring-brand-500 text-sm">
                </div>
                <div class="flex flex-col gap-2 pt-2">
                    <button onclick="syncWithId()" class="w-full bg-brand-600 text-white font-bold py-3 rounded-xl shadow-lg">同期を実行</button>
                    <button onclick="closeLoginModal()" class="w-full py-2 text-slate-400 text-sm font-medium">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <div id="goalModal" class="hidden fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold mb-4">目標の設定</h2>
            <form id="goalForm" class="space-y-4">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">日の目標（h）</label><input type="number" id="goalDaily" step="0.5" required class="w-full px-4 py-2 border rounded-xl outline-none"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">週の目標（h）</label><input type="number" id="goalWeekly" step="1" required class="w-full px-4 py-2 border rounded-xl outline-none"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">月の目標（h）</label><input type="number" id="goalMonthly" step="1" required class="w-full px-4 py-2 border rounded-xl outline-none"></div>
                <button type="submit" class="w-full bg-brand-600 text-white font-bold py-3 rounded-xl mt-4 shadow-lg">保存する</button>
                <button type="button" onclick="closeGoalModal()" class="w-full py-2 text-slate-400 text-sm">閉じる</button>
            </form>
        </div>
    </div>

    <div id="examModal" class="hidden fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl flex flex-col max-h-[80vh]">
            <h2 class="text-xl font-bold mb-4">試験日の管理</h2>
            <form id="addExamForm" class="space-y-3 mb-4">
                <input type="text" id="newExamName" placeholder="試験名" required class="w-full px-4 py-2 border rounded-xl outline-none text-sm">
                <input type="date" id="newExamDate" required class="w-full px-4 py-2 border rounded-xl outline-none text-sm">
                <button type="submit" class="w-full bg-brand-600 text-white font-bold py-2 rounded-xl text-sm">追加</button>
            </form>
            <div id="examModalList" class="overflow-y-auto space-y-2 flex-grow"></div>
            <button onclick="closeExamModal()" class="w-full py-3 text-slate-400 text-sm font-medium mt-2">閉じる</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === Firebase Configuration ===
        const firebaseConfig = {
            apiKey: "AIzaSyAByhWq2P8kvgG0nX6vZPfHphyF1M81Ze4",
            authDomain: "studytracker-810d7.firebaseapp.com",
            projectId: "studytracker-810d7",
            storageBucket: "studytracker-810d7.firebasestorage.app",
            messagingSenderId: "247864942142",
            appId: "1:247864942142:web:8f1db29dfd3c9616bf3b6f",
            measurementId: "G-S5M5MH306R"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const artifactId = 'study-tracker-app';

        // === 状態管理 ===
        let records = [];
        let goals = { daily: 4, weekly: 25, monthly: 100 };
        let exams = [];
        let mockRecords = [];
        let currentUserId = localStorage.getItem('study_tracker_sync_id'); // 同期IDの取得
        let myChart = null, mockChartInstance = null;
        let inputMode = 'manual', timerInterval = null, timerSeconds = 0, isTimerRunning = false;

        // === 認証・初期化 ===
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                // ローカルストレージにIDがない場合は、今ログインしたIDをデフォルトにする
                if (!currentUserId) {
                    currentUserId = u.uid;
                    localStorage.setItem('study_tracker_sync_id', currentUserId);
                }
                document.getElementById('idDisplay').textContent = `ID: ${currentUserId}`;
                document.getElementById('myIdText').textContent = currentUserId;
                setupRealtimeListeners();
                document.getElementById('loadingOverlay').classList.add('hidden');
            } else {
                signInAnonymously(auth).catch(err => alert("接続エラー: " + err.message));
            }
        });

        // === ID同期（ログイン）機能 ===
        window.syncWithId = () => {
            const inputId = document.getElementById('syncIdInput').value.trim();
            if (inputId.length < 10) {
                alert("有効なIDを入力してください。");
                return;
            }
            if (confirm("入力されたIDのデータに切り替えますか？")) {
                localStorage.setItem('study_tracker_sync_id', inputId);
                location.reload(); // IDを切り替えてリロード
            }
        };

        window.copyMyId = () => {
            const id = document.getElementById('myIdText').textContent;
            navigator.clipboard.writeText(id).then(() => alert("IDをコピーしました。スマホのログイン画面で貼り付けてください。"));
        };

        // === Firestore リアルタイム同期 ===
        let unsubscribeFuncs = [];
        function setupRealtimeListeners() {
            if (!currentUserId) return;
            unsubscribeFuncs.forEach(unsub => unsub()); // 既存リスナー解除
            const userRef = doc(db, 'artifacts', artifactId, 'users', currentUserId);

            unsubscribeFuncs.push(onSnapshot(collection(userRef, 'study_records'), (snap) => {
                records = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateUI();
            }));

            unsubscribeFuncs.push(onSnapshot(doc(userRef, 'settings', 'goals'), (d) => {
                if (d.exists()) { goals = d.data(); updateUI(); }
            }));

            unsubscribeFuncs.push(onSnapshot(collection(userRef, 'exams'), (snap) => {
                exams = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateUI();
            }));

            unsubscribeFuncs.push(onSnapshot(collection(userRef, 'mock_exams'), (snap) => {
                mockRecords = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateMockUI();
            }));
        }

        // === 基本操作 ===
        window.switchView = (view) => {
            document.getElementById('dashboardView').classList.toggle('hidden', view !== 'dashboard');
            document.getElementById('mockExamView').classList.toggle('hidden', view !== 'mock-exams');
            document.getElementById('tab-dashboard').className = view === 'dashboard' ? 'flex-1 py-3 text-sm font-bold border-b-2 border-brand-500 text-brand-700 bg-brand-50/30' : 'flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700';
            document.getElementById('tab-mock-exams').className = view === 'mock-exams' ? 'flex-1 py-3 text-sm font-bold border-b-2 border-brand-500 text-brand-700 bg-brand-50/30' : 'flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700';
        };

        window.setInputMode = (mode) => {
            inputMode = mode;
            document.getElementById('manualTimeInput').classList.toggle('hidden', mode !== 'manual');
            document.getElementById('timerTimeInput').classList.toggle('hidden', mode !== 'timer');
            document.getElementById('modeBtnManual').className = mode === 'manual' ? 'flex-1 py-2 text-sm font-bold rounded-md bg-white shadow-sm text-brand-700' : 'flex-1 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-700';
            document.getElementById('modeBtnTimer').className = mode === 'timer' ? 'flex-1 py-2 text-sm font-bold rounded-md bg-white shadow-sm text-brand-700' : 'flex-1 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-700';
        };

        window.toggleTimer = () => {
            const sBtn = document.getElementById('timerStartBtn'), pBtn = document.getElementById('timerPauseBtn');
            if (isTimerRunning) {
                clearInterval(timerInterval); isTimerRunning = false;
                sBtn.classList.remove('hidden'); pBtn.classList.add('hidden'); sBtn.textContent = '再開';
            } else {
                isTimerRunning = true; sBtn.classList.add('hidden'); pBtn.classList.remove('hidden');
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    const h = Math.floor(timerSeconds/3600), m = Math.floor((timerSeconds%3600)/60), s = timerSeconds%60;
                    document.getElementById('timerDisplay').textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                }, 1000);
            }
        };

        window.resetTimer = () => {
            clearInterval(timerInterval); isTimerRunning = false; timerSeconds = 0;
            document.getElementById('timerDisplay').textContent = "00:00:00";
            document.getElementById('timerStartBtn').classList.remove('hidden');
            document.getElementById('timerPauseBtn').classList.add('hidden');
            document.getElementById('timerStartBtn').textContent = '開始';
        };

        // --- データ更新 ---
        document.getElementById('recordForm').onsubmit = async (e) => {
            e.preventDefault(); if (!currentUserId) return;
            const dur = inputMode === 'manual' ? parseInt(document.getElementById('duration').value) : Math.max(1, Math.round(timerSeconds/60));
            if (isNaN(dur)) return;
            await addDoc(collection(db, 'artifacts', artifactId, 'users', currentUserId, 'study_records'), {
                date: document.getElementById('date').value,
                subject: document.getElementById('subject').value,
                duration: dur,
                memo: document.getElementById('memo').value,
                createdAt: Date.now()
            });
            e.target.reset(); document.getElementById('date').value = new Date().toISOString().split('T')[0]; resetTimer();
        };

        window.deleteRecord = async (id) => { if (confirm("削除しますか？")) await deleteDoc(doc(db, 'artifacts', artifactId, 'users', currentUserId, 'study_records', id)); };

        // モーダル制御
        window.openLoginModal = () => document.getElementById('loginModal').classList.remove('hidden');
        window.closeLoginModal = () => document.getElementById('loginModal').classList.add('hidden');
        window.openGoalModal = () => {
            document.getElementById('goalDaily').value = goals.daily;
            document.getElementById('goalWeekly').value = goals.weekly;
            document.getElementById('goalMonthly').value = goals.monthly;
            document.getElementById('goalModal').classList.remove('hidden');
        };
        window.closeGoalModal = () => document.getElementById('goalModal').classList.add('hidden');
        document.getElementById('goalForm').onsubmit = async (e) => {
            e.preventDefault();
            await setDoc(doc(db, 'artifacts', artifactId, 'users', currentUserId, 'settings', 'goals'), {
                daily: parseFloat(document.getElementById('goalDaily').value),
                weekly: parseFloat(document.getElementById('goalWeekly').value),
                monthly: parseFloat(document.getElementById('goalMonthly').value)
            });
            closeGoalModal();
        };

        window.openExamModal = () => { document.getElementById('examModal').classList.remove('hidden'); renderExamModalList(); };
        window.closeExamModal = () => document.getElementById('examModal').classList.add('hidden');
        document.getElementById('addExamForm').onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, 'artifacts', artifactId, 'users', currentUserId, 'exams'), {
                name: document.getElementById('newExamName').value,
                date: document.getElementById('newExamDate').value
            });
            e.target.reset();
        };
        window.deleteExam = async (id) => { await deleteDoc(doc(db, 'artifacts', artifactId, 'users', currentUserId, 'exams', id)); };

        document.getElementById('mockExamForm').onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, 'artifacts', artifactId, 'users', currentUserId, 'mock_exams'), {
                date: document.getElementById('mockDate').value,
                name: document.getElementById('mockName').value,
                score: parseInt(document.getElementById('mockScore').value),
                maxScore: parseInt(document.getElementById('mockMaxScore').value)
            });
            e.target.reset(); document.getElementById('mockDate').value = new Date().toISOString().split('T')[0];
        };
        window.deleteMockExam = async (id) => { if(confirm("削除しますか？")) await deleteDoc(doc(db, 'artifacts', artifactId, 'users', currentUserId, 'mock_exams', id)); };

        // --- レンダリング ---
        function updateUI() {
            records.sort((a,b) => new Date(b.date) - new Date(a.date));
            const total = records.reduce((s, r) => s + r.duration, 0);
            document.getElementById('totalTimeDisplay').textContent = `${Math.floor(total/60)}h ${total%60}m`;
            const m = new Date().toISOString().slice(0,7);
            const days = new Set(records.filter(r => r.date.startsWith(m)).map(r => r.date));
            document.getElementById('totalDaysDisplay').textContent = `${days.size}日`;

            renderProgress(); renderExams(); renderTable(); renderChart();
        }

        function renderProgress() {
            const now = new Date(), today = now.toISOString().split('T')[0];
            const mon = today.substring(0,7), d = new Date(now);
            const startW = new Date(d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1))).setHours(0,0,0,0);
            let s = { d: 0, w: 0, m: 0 };
            records.forEach(r => {
                if (r.date === today) s.d += r.duration;
                if (new Date(r.date).setHours(0,0,0,0) >= startW) s.w += r.duration;
                if (r.date.startsWith(mon)) s.m += r.duration;
            });
            const upd = (id, cur, tar, lbl) => {
                const p = tar > 0 ? Math.min(100, Math.round((cur/(tar*60))*100)) : 0;
                document.getElementById(id).innerHTML = `<div class="flex justify-between text-[10px] font-bold mb-1"><span class="text-slate-400 uppercase">${lbl}</span><span class="text-slate-700">${(cur/60).toFixed(1)} / ${tar}h</span></div><div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden"><div class="${p>=100?'bg-green-500':'bg-brand-500'} h-1.5 rounded-full" style="width: ${p}%"></div></div>`;
            };
            upd('dailyProgress', s.d, goals.daily, 'Daily Goal'); upd('weeklyProgress', s.w, goals.weekly, 'Weekly Goal'); upd('monthlyProgress', s.m, goals.monthly, 'Monthly Goal');
        }

        function renderExams() {
            const container = document.getElementById('examListDisplay'); container.innerHTML = '';
            const today = new Date(); today.setHours(0,0,0,0);
            exams.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(e => {
                const diff = Math.ceil((new Date(e.date) - today) / 86400000);
                const color = diff <= 14 ? 'bg-rose-50 text-rose-700 border-rose-100' : 'bg-brand-50 text-brand-700 border-brand-100';
                container.innerHTML += `<div class="border rounded-xl p-3 ${color} flex justify-between items-center"><div class="flex flex-col"><span class="text-[10px] font-bold uppercase opacity-60">${e.name}</span><span class="text-sm font-bold">${diff>0?`あと${diff}日`:diff===0?'本日試験':'終了'}</span></div><span class="text-[10px] font-mono opacity-50">${e.date}</span></div>`;
            });
        }

        function renderExamModalList() {
            const list = document.getElementById('examModalList'); list.innerHTML = '';
            exams.forEach(e => {
                list.innerHTML += `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100"><div><div class="font-bold text-xs">${e.name}</div><div class="text-[10px] text-slate-400 font-mono">${e.date}</div></div><button onclick="deleteExam('${e.id}')" class="text-slate-300 hover:text-red-500"><i class="ph ph-trash-simple text-lg"></i></button></div>`;
            });
        }

        function renderTable() {
            const tbody = document.getElementById('recordList'); tbody.innerHTML = '';
            records.slice(0, 15).forEach(r => {
                const colors = { '数的処理': 'text-blue-600', '憲法': 'text-red-600', '民法': 'text-orange-600' };
                const dot = colors[r.subject] || 'text-slate-400';
                tbody.innerHTML += `<tr class="flex items-center justify-between p-4"><td class="flex flex-col"><span class="text-[10px] font-mono text-slate-400">${r.date}</span><span class="text-sm font-bold flex items-center gap-1"><i class="ph-fill ph-circle ${dot} text-[8px]"></i>${r.subject}</span><span class="text-[10px] text-slate-500 italic truncate max-w-[150px]">${r.memo||''}</span></td><td class="flex items-center gap-4"><span class="text-xs font-mono font-bold text-slate-700">${Math.floor(r.duration/60)}h${r.duration%60}m</span><button onclick="deleteRecord('${r.id}')" class="text-slate-300 hover:text-red-500"><i class="ph ph-x-circle text-xl"></i></button></td></tr>`;
            });
            document.getElementById('emptyState').classList.toggle('hidden', records.length > 0);
        }

        function renderChart() {
            const ctx = document.getElementById('subjectChart');
            const totals = {}; records.forEach(r => totals[r.subject] = (totals[r.subject]||0) + r.duration);
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: Object.keys(totals), datasets: [{ data: Object.values(totals), backgroundColor: ['#0ea5e9','#ef4444','#22c55e','#a855f7','#f97316','#64748b'], borderWidth: 4, borderColor: '#fff' }]},
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, font: { size: 10 } } }}}
            });
        }

        function updateMockUI() {
            mockRecords.sort((a,b) => new Date(a.date) - new Date(b.date));
            const tbody = document.getElementById('mockList'); tbody.innerHTML = '';
            [...mockRecords].reverse().forEach(r => {
                const p = Math.round((r.score/r.maxScore)*100);
                tbody.innerHTML += `<tr class="flex items-center justify-between p-4"><td><div class="text-[10px] text-slate-400 font-mono">${r.date}</div><div class="text-sm font-bold">${r.name}</div><div class="text-[10px] text-slate-500">${r.score} / ${r.maxScore}</div></td><td class="flex items-center gap-4"><div class="text-lg font-bold ${p>=70?'text-green-500':'text-brand-500'}">${p}%</div><button onclick="deleteMockExam('${r.id}')" class="text-slate-300"><i class="ph ph-trash-simple text-xl"></i></button></td></tr>`;
            });
            document.getElementById('mockEmptyState').classList.toggle('hidden', mockRecords.length > 0);
            const ctx = document.getElementById('mockScoreChart');
            if (mockChartInstance) mockChartInstance.destroy();
            mockChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: mockRecords.map(r=>r.name), datasets: [{ data: mockRecords.map(r=>(r.score/r.maxScore*100).toFixed(1)), borderColor:'#0ea5e9', backgroundColor:'rgba(14,165,233,0.1)', fill:true, tension:0.4 }]},
                options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }}, scales:{ y:{ min:0, max:100, ticks:{ font:{size:10} } }, x:{ ticks:{ font:{size:8} } }}}
            });
        }

        // 初期設定
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        document.getElementById('mockDate').value = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>
